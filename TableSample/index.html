<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>企業・部署・従業員ビューア（列選択＋チェックボックス式フィルタ＋可視化）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"
          integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
  <style>
    :root { --bd:#ddd; --bg:#fff; --muted:#666; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; margin: 24px; }
    h1 { font-size: 20px; margin-bottom: 8px; }
    .muted { color: var(--muted); font-size: 12px; }
    .toolbar { display: flex; flex-wrap: wrap; gap: 8px 12px; align-items: center; margin-top: 8px; }
    .btn { padding: 6px 10px; border: 1px solid #bbb; background: var(--bg); border-radius: 8px; cursor: pointer; }
    .btn:hover { background: #f5f5f5; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border: 1px solid var(--bd); padding: 10px; vertical-align: top; }
    th { background: #f7f7f7; cursor: pointer; position: relative; white-space: nowrap; }
    tr:nth-child(even) td { background: #fafafa; }
    .dept-btn { display: inline-block; margin: 2px 0; padding: 4px 8px; border: 1px solid #bbb; background: var(--bg); border-radius: 6px; cursor: pointer; }
    .dept-btn:hover { background: #f0f8ff; }

    /* フィルタパネル */
    .filter-panel {
      position: absolute; z-index: 20; background: var(--bg); border: 1px solid #cfcfcf; border-radius: 10px;
      padding: 10px; box-shadow: 0 10px 28px rgba(0,0,0,0.14); display: none; min-width: 260px; max-width: 360px;
    }
    .filter-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
    .filter-title { font-weight: 600; }
    .filter-tools { display: flex; gap: 6px; }
    .filter-options { max-height: 220px; overflow: auto; border: 1px solid var(--bd); border-radius: 8px; padding: 6px; }
    .filter-option { display: flex; align-items: center; gap: 6px; margin: 4px 2px; }
    .filter-actions { margin-top: 8px; text-align: right; display: flex; justify-content: flex-end; gap: 8px; }

    /* 汎用モーダル（列選択／従業員に共用バックドロップ） */
    .backdrop { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 10; }
    .modal { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); background: var(--bg);
      width: min(560px, 92vw); max-height: 72vh; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.22); z-index: 30; display: none; }
    .modal header { padding: 14px 16px; font-weight: bold; border-bottom: 1px solid #eee; }
    .modal .content { padding: 16px; overflow: auto; }
    .modal footer { padding: 12px 16px; border-top: 1px solid #eee; text-align: right; display: flex; gap: 8px; justify-content: flex-end; }

    /* チップ */
    .chip { display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; border-radius: 9999px; border: 1px solid #ddd; margin: 2px 4px 2px 0; font-size: 12px; background:#fafafa; }
    .chip .chip-x { border:none; background:transparent; cursor:pointer; font-size:12px; padding:0 2px; line-height:1; }
    .chip .chip-x:hover { text-decoration: underline; }

    /* 列選択モーダル内 */
    .col-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 8px 12px; }
    .col-item { display: flex; align-items: center; gap: 8px; }

    /* ステータステキスト */
    .badge { display: inline-block; padding: 2px 8px; border: 1px solid #ddd; border-radius: 9999px; font-size: 12px; margin-left: 8px; background: #fafafa; }

    /* フィルタ状態エリア */
    .filters-wrap { display:flex; flex-wrap: wrap; align-items: center; gap: 6px 8px; }
    .filters-title { font-size: 12px; color: var(--muted); margin-right: 2px; }
    .filters-empty { font-size:12px; color: var(--muted); }
  </style>
</head>
<body>
  <h1>企業 × 部署 × 従業員（3階層JSON）</h1>
  <p class="muted">①「項目選択」で表示する列を選ぶ → ② ヘッダーをクリックしてチェックボックス式フィルタ → ③ 部署クリックで従業員モーダル。<br>※ フィルタ状態は下のチップで常時表示・ワンクリック解除できます。</p>

  <div class="toolbar">
    <button class="btn" id="openColPicker">項目選択</button>
    <span class="muted">現在の列: <span id="visibleColsStatus" class="badge">読み込み中...</span></span>
    <!-- フィルタ状態の常時可視化 -->
    <div id="activeFilters" class="filters-wrap" aria-live="polite">
      <span class="filters-title">フィルタ:</span>
      <span class="filters-empty" id="filtersEmpty">未適用</span>
      <!-- 個別フィルタのチップがここに入る -->
    </div>
  </div>

  <table id="companyTable" aria-label="companies table">
    <thead></thead>
    <tbody></tbody>
  </table>

  <!-- ヘッダーフィルタパネル（1つを使い回し） -->
  <div id="filterPanel" class="filter-panel" role="dialog" aria-modal="false" aria-label="ヘッダーフィルタ">
    <div class="filter-head">
      <div class="filter-title" id="filterTitle">フィルタ</div>
      <div class="filter-tools">
        <button class="btn" id="checkAll">全選択</button>
        <button class="btn" id="uncheckAll">全解除</button>
      </div>
    </div>
    <div id="filterOptions" class="filter-options" role="group" aria-labelledby="filterTitle"></div>
    <div class="filter-actions">
      <button class="btn" id="applyFilter">適用</button>
      <button class="btn" id="clearFilter">リセット</button>
      <button class="btn" id="closeFilter">閉じる</button>
    </div>
  </div>

  <!-- バックドロップ（共用） -->
  <div id="backdrop" class="backdrop" aria-hidden="true"></div>

  <!-- 従業員モーダル -->
  <div id="employeeModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="empModalTitle">
    <header id="empModalTitle">従業員リスト</header>
    <div class="content" id="empModalContent"></div>
    <footer>
      <button class="btn" id="closeEmployeeModal">閉じる</button>
    </footer>
  </div>

  <!-- 列選択モーダル -->
  <div id="colPickerModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="colPickerTitle">
    <header id="colPickerTitle">項目選択（表示する列をチェック）</header>
    <div class="content">
      <div id="colPickerList" class="col-grid" role="group" aria-labelledby="colPickerTitle"></div>
    </div>
    <footer>
      <button class="btn" id="selectAllCols">全選択</button>
      <button class="btn" id="unselectAllCols">全解除</button>
      <button class="btn" id="applyCols">適用</button>
      <button class="btn" id="closeColPicker">閉じる</button>
    </footer>
  </div>

  <script>
    // ====== 列メタ定義 ======
    const COLUMNS = [
      { key: 'name',       title: '会社名',   filterable: true },
      { key: 'location',   title: '所在地',   filterable: true },
      { key: 'departments',title: '部署一覧', filterable: true } // 2階層を1セルに改行表示
    ];

    // ====== アプリ状態 ======
    const AppState = {
      companies: [],
      visibleCols: COLUMNS.map(c => c.key),
      filters: { name: null, location: null, departments: null },
      lastHeader: null
    };

    // ====== 初期化 ======
    $(async function () {
      try {
        const data = await $.getJSON('data.json'); // { companies: [...] }
        AppState.companies = data.companies || [];
        renderAll();
      } catch (e) {
        alert('data.json の読み込みに失敗しました。ローカルで開いている場合は、静的サーバで実行してください。');
      }

      // --- ヘッダー→フィルタパネル ---
      $(document).on('click keydown', '#companyTable thead th[data-col]', function (evt) {
        if (evt.type === 'keydown' && !(evt.key === 'Enter' || evt.key === ' ')) return;
        const $th = $(this);
        const colKey = $th.data('col');
        const meta = COLUMNS.find(c => c.key === colKey);
        if (!meta?.filterable) return;
        AppState.lastHeader = colKey;
        openFilterPanel($th, colKey, meta.title);
      });

      // フィルタ操作
      $('#applyFilter').on('click', () => { applyCurrentFilter(); });
      $('#clearFilter').on('click', () => { clearCurrentFilter(); });
      $('#closeFilter').on('click', hideFilterPanel);
      $('#checkAll').on('click', () => $('#filterOptions input[type="checkbox"]').prop('checked', true));
      $('#uncheckAll').on('click', () => $('#filterOptions input[type="checkbox"]').prop('checked', false));

      // パネル外クリックで閉じる
      $(document).on('click', function (e) {
        const $panel = $('#filterPanel');
        if ($panel.is(':visible') && !$(e.target).closest('#filterPanel, #companyTable thead th').length) hideFilterPanel();
      });

      // --- 従業員モーダル ---
      $('#closeEmployeeModal, #backdrop').on('click', closeAllModals);
      $(document).on('keydown', e => { if (e.key === 'Escape') closeAllModals(); });

      // --- 項目選択（列選択） ---
      $('#openColPicker').on('click', openColPicker);
      $('#closeColPicker').on('click', closeAllModals);
      $('#selectAllCols').on('click', () => $('#colPickerList input[type="checkbox"]').prop('checked', true));
      $('#unselectAllCols').on('click', () => $('#colPickerList input[type="checkbox"]').prop('checked', false));
      $('#applyCols').on('click', applyColumnSelection);

      // --- 可視化チップからフィルタをワンクリック解除 ---
      $(document).on('click', '.chip-x[data-clear-filter]', function (e) {
        e.stopPropagation();
        const col = $(this).data('clear-filter');
        AppState.filters[col] = null;
        renderTableHead();
        renderFilterStatus();
        renderTableBody();
      });

      // キーボード操作（Enter/Space）でのフィルタ解除対応
      $(document).on('keydown', '.chip-x[data-clear-filter]', function (e) {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          $(this).trigger('click');
        }
      });
    });

    // ====== 全体レンダリング ======
    function renderAll() {
      renderTableHead();
      renderFilterStatus();
      renderTableBody();
      updateVisibleColsStatus();
    }

    // ====== THEAD描画（選択列のみ） ======
    function renderTableHead() {
      const $thead = $('#companyTable thead').empty();
      const $tr = $('<tr>');
      AppState.visibleCols.forEach(key => {
        const meta = COLUMNS.find(c => c.key === key);
        if (!meta) return;

        const activeCount = Array.isArray(AppState.filters[key]) ? AppState.filters[key].length : 0;
        const $th = $('<th>').attr('data-col', meta.key)
          .attr('tabindex', meta.filterable ? 0 : -1)
          .attr('aria-haspopup', meta.filterable ? 'dialog' : 'false');

        const label = meta.title + (meta.filterable ? '（クリックでフィルタ）' : '');
        const $labelSpan = $('<span>').text(label);
        $th.append($labelSpan);

        if (activeCount > 0) {
          // バッジでアクティブ件数を可視化
          $th.append($('<span class="badge">').text(activeCount));
          $th.attr('aria-label', `${meta.title} に ${activeCount} 件のフィルタが適用中`);
        }

        $tr.append($th);
      });
      $thead.append($tr);
    }

    // ====== TBODY描画（選択列のみ） ======
    function renderTableBody() {
      const $tbody = $('#companyTable tbody').empty();
      AppState.companies
        .filter(companyPassesFilters)
        .forEach(c => {
          const $tr = $('<tr>');
          AppState.visibleCols.forEach(key => {
            if (key === 'name') {
              $tr.append($('<td>').text(c.name));
            } else if (key === 'location') {
              $tr.append($('<td>').text(c.location));
            } else if (key === 'departments') {
              const $td = $('<td>');
              c.departments.forEach((d, idx) => {
                const $btn = $('<button class="dept-btn" type="button">')
                  .text(d.name)
                  .attr('data-company', c.name)
                  .attr('data-dept', d.name)
                  .on('click', () => openEmployeesModal(c.name, d.name, d.employees));
                $td.append($btn);
                if (idx < c.departments.length - 1) $td.append('<br/>');
              });
              $tr.append($td);
            }
          });
          $tbody.append($tr);
        });
    }

    // ====== フィルタ判定（チェックボックス複数選択対応） ======
    function companyPassesFilters(c) {
      const activeCols = new Set(AppState.visibleCols);
      const f = AppState.filters;

      if (activeCols.has('name') && Array.isArray(f.name) && f.name.length > 0 && !f.name.includes(c.name)) return false;
      if (activeCols.has('location') && Array.isArray(f.location) && f.location.length > 0 && !f.location.includes(c.location)) return false;
      if (activeCols.has('departments') && Array.isArray(f.departments) && f.departments.length > 0) {
        const hasDept = c.departments.some(d => f.departments.includes(d.name));
        if (!hasDept) return false;
      }
      return true;
    }

    // ====== フィルタ状態の常時可視化 ======
    function renderFilterStatus() {
      const $wrap = $('#activeFilters');
      // 既存の動的チップをクリア（タイトルと「未適用」は残すので後で再制御）
      $wrap.find('.chip').remove();

      const active = [];
      AppState.visibleCols.forEach(key => {
        const meta = COLUMNS.find(c => c.key === key);
        const vals = AppState.filters[key];
        if (Array.isArray(vals) && vals.length > 0) {
          active.push({ key, title: meta?.title ?? key, vals });
        }
      });

      if (active.length === 0) {
        $('#filtersEmpty').show().text('未適用');
        return;
      } else {
        $('#filtersEmpty').hide();
      }

      active.forEach(({ key, title, vals }) => {
        const text = `${title}: ${vals.join(' / ')}`;
        const $chip = $('<span class="chip">')
          .append($('<span>').text(text))
          .append(
            $('<button class="chip-x" type="button" title="このフィルタを解除" aria-label="このフィルタを解除">')
              .attr('data-clear-filter', key)
              .text('✕')
  );

        $wrap.append($chip);
      });
    }

    // ====== フィルタパネル ======
    function openFilterPanel($th, colKey, title) {
      const $panel = $('#filterPanel');
      const $opts = $('#filterOptions').empty();

      $('#filterTitle').text(`フィルタ：${title}`);

      // --- 候補値を抽出して昇順ソート ---
      const values = getUniqueValuesForColumn(colKey).sort((a, b) => a.localeCompare(b, 'ja'));

      // --- 候補を描画 ---
      values.forEach(v => {
        const id = `opt-${colKey}-${encodeURIComponent(v)}`;
        const $row = $('<label class="filter-option">')
          .append($('<input type="checkbox">').attr({ id, value: v, name: 'filterOption' }))
          .append($('<span>').text(v));
        $opts.append($row);
      });

      // 既存選択反映
      const cur = AppState.filters[colKey] || [];
      if (Array.isArray(cur) && cur.length > 0) {
        cur.forEach(v => $opts.find(`input[type="checkbox"][value="${cssEscape(v)}"]`).prop('checked', true));
      }

      // 位置（ヘッダー直下）
      const off = $th.offset();
      const top = off.top + $th.outerHeight();
      const left = off.left;
      $panel.css({ top: top + 6, left: left }).show().attr('aria-modal', 'true');

      // 初期フォーカス
      setTimeout(() => $opts.find('input[type="checkbox"]').first().trigger('focus'), 0);
    }


    function hideFilterPanel() { $('#filterPanel').hide().attr('aria-modal', 'false'); }

    function getUniqueValuesForColumn(colKey) {
      const set = new Set();
      for (const c of AppState.companies) {
        if (colKey === 'name') set.add(c.name);
        else if (colKey === 'location') set.add(c.location);
        else if (colKey === 'departments') c.departments.forEach(d => set.add(d.name));
      }
      return Array.from(set).sort((a, b) => a.localeCompare(b, 'ja'));
    }

    function applyCurrentFilter() {
      if (!AppState.lastHeader) return;
      const selected = $('#filterOptions input[type="checkbox"]:checked').map((_, el) => $(el).val()).get();
      AppState.filters[AppState.lastHeader] = selected.length > 0 ? selected : null;
      hideFilterPanel();
      renderTableHead();    // バッジ更新
      renderFilterStatus(); // チップ更新
      renderTableBody();    // データ再描画
    }

    function clearCurrentFilter() {
      if (!AppState.lastHeader) return;
      AppState.filters[AppState.lastHeader] = null;
      hideFilterPanel();
      renderTableHead();
      renderFilterStatus();
      renderTableBody();
    }

    // ====== 従業員モーダル ======
    function openEmployeesModal(companyName, deptName, employees) {
      $('#empModalTitle').text(`従業員リスト：${companyName} / ${deptName}`);
      const $content = $('#empModalContent').empty();
      if (!employees || employees.length === 0) {
        $content.append('<p>従業員データがありません。</p>');
      } else {
        employees.forEach(emp => $content.append($('<span class="chip">').text(emp)));
      }
      showModal('#employeeModal');
    }

    // ====== 列選択モーダル ======
    function openColPicker() {
      const $list = $('#colPickerList').empty();
      COLUMNS.forEach(col => {
        const id = `col-${col.key}`;
        const $item = $('<label class="col-item">')
          .append($('<input type="checkbox">').attr({ id, value: col.key }))
          .append($('<span>').text(col.title));
        $list.append($item);
      });
      // 現在の表示列を反映
      $('#colPickerList input[type="checkbox"]').each(function () {
        $(this).prop('checked', AppState.visibleCols.includes($(this).val()));
      });

      showModal('#colPickerModal');
    }

    function applyColumnSelection() {
      const selected = $('#colPickerList input[type="checkbox"]:checked').map((_, el) => $(el).val()).get();
      if (selected.length === 0) {
        alert('少なくとも1つの列を選択してください。');
        return;
      }
      AppState.visibleCols = selected;

      // 非表示にした列のフィルタはクリア
      const active = new Set(AppState.visibleCols);
      for (const k of Object.keys(AppState.filters)) {
        if (!active.has(k)) AppState.filters[k] = null;
      }

      closeAllModals();
      renderAll(); // ヘッダー/チップ/本文/列ステータスを一括更新
    }

    // ====== 共通：モーダル制御・UI ======
    function showModal(selector) {
      $('#backdrop').show().attr('aria-hidden', 'false');
      $(selector).show();
    }
    function closeAllModals() {
      $('.modal').hide();
      $('#backdrop').hide().attr('aria-hidden', 'true');
      hideFilterPanel();
    }

    function updateVisibleColsStatus() {
      const labels = AppState.visibleCols
        .map(k => COLUMNS.find(c => c.key === k)?.title || k)
        .join(', ');
      $('#visibleColsStatus').text(labels);
    }

    // CSSエスケープ（値に特殊文字が入る可能性に備える）
    function cssEscape(str) { return String(str).replace(/(["'\\])/g, '\\$1'); }
  </script>
</body>
</html>
