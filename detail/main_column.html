<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bootstrap + jQuery（手動列プリセット・配列オブジェクト表示・詳細は表示中列のみ）</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    /* 横・縦スクロール */
    .table-wrap{
      max-height: 60vh;
      overflow-y: auto;
      overflow-x: auto;
    }

    /* 列幅制御のため固定レイアウト */
    table.fixed-table{
      table-layout: fixed;
      width: 100%;
    }

    /* 操作カラム固定幅（カラム数が増えても変わらない） */
    th.col-action, td.col-action{
      width: 160px;
      min-width: 160px;
      max-width: 160px;
      white-space: nowrap;
      text-align: center;
      vertical-align: middle;
    }

    .action-btns{
      display: inline-flex;
      gap: .25rem;
      justify-content: center;
      width: 100%;
    }

    td, th { overflow: hidden; text-overflow: ellipsis; }

    /* モーダルの「編集不可」を分かりやすく */
    .form-control[readonly] { cursor: not-allowed; }

    /* 詳細モーダル内のグリッド */
    .kv-row {
      display: grid;
      grid-template-columns: 180px 1fr;
      gap: .5rem 1rem;
      align-items: center;
    }
    .kv-row + .kv-row { margin-top: .75rem; }
    .kv-key { font-weight: 600; }
  </style>
</head>
<body class="bg-light">

<div class="container py-4">

  <!-- Header -->
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <h1 class="h4 m-0">トップ画面</h1>

    <div class="d-flex flex-wrap gap-2 align-items-center">
      <!-- 列プリセット：全件/偶数/奇数 -->
      <select class="form-select form-select-sm w-auto" id="columnPreset">
        <option value="all" selected>全件</option>
        <option value="even">偶数</option>
        <option value="odd">奇数</option>
      </select>

      <button class="btn btn-primary btn-sm" type="button" id="addDummyRowBtn">ダミー追加</button>
    </div>
  </div>

  <!-- Table -->
  <div class="card shadow-sm">
    <div class="card-body">

      <div class="table-wrap">
        <table class="table table-bordered table-hover align-middle mb-0 fixed-table" id="mainTable">
          <!-- colgroup / thead はJSで生成 -->
          <colgroup id="colgroup"></colgroup>
          <thead class="table-light">
            <tr id="theadRow"></tr>
          </thead>
          <tbody id="mainTbody"></tbody>
        </table>
      </div>

      <!-- ページネーション（100件以上のときだけ表示） -->
      <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mt-3">
        <div class="text-muted small" id="resultInfo">-</div>

        <nav aria-label="ページネーション" id="pagerWrap" class="d-none">
          <ul class="pagination pagination-sm mb-0" id="pager"></ul>
        </nav>
      </div>

    </div>
  </div>
</div>

<!-- Modal（詳細：表示中の列のみ表示） -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header d-flex justify-content-between align-items-center">
        <h5 class="modal-title">詳細</h5>

        <div class="btn-group btn-group-sm" role="group">
          <button type="button" class="btn btn-outline-secondary active" id="viewModeBtn">閲覧</button>
          <button type="button" class="btn btn-outline-secondary" id="editModeBtn">編集</button>
        </div>
      </div>

      <div class="modal-body">
        <!-- ここを現在の列プリセットに応じて動的生成 -->
        <div id="detailContainer" class="vstack gap-3"></div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">閉じる</button>
        <button type="button" class="btn btn-success edit-mode d-none" id="saveBtn">保存</button>
      </div>

    </div>
  </div>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
$(function () {
  // =============================
  // 1) 入力データ例：配列内オブジェクト（1オブジェクト=1行）
  //    ※ 実運用ではAPIからこの形で受け取って records に代入する想定
  // =============================
  const TEST_COL_COUNT = 12; // テスト1〜テスト12

  let records = generateRecords(230); // 例：230件（ページネーション動作確認用）

  // 例：records の形（参考）
  // records = [
  //   { test1: "値1-1", test2: "値2-1", ... test12:"値12-1" },
  //   { test1: "値1-2", test2: "値2-2", ... },
  // ];

  function generateRecords(n) {
    const arr = [];
    for (let row = 1; row <= n; row++) {
      const obj = {};
      for (let c = 1; c <= TEST_COL_COUNT; c++) {
        obj[`test${c}`] = `値${c}-${row}`;
      }
      arr.push(obj);
    }
    return arr;
  }

  // =============================
  // 2) 列定義（見出しは「テスト1、テスト2、…」）
  // =============================
  const COLS = [
    { key: "action", label: "操作", width: 160, isAction: true },
    ...Array.from({length: TEST_COL_COUNT}, (_, i) => ({
      key: `test${i+1}`,
      label: `テスト${i+1}`,
      width: (i === 0 ? 130 : 160) // テスト1は少し狭め例
    }))
  ];

  // =============================
  // 3) 列プリセット（手動で設定）
  //    even/odd を自動計算ではなく、ここで手動指定
  // =============================
  const COLUMN_PRESETS = {
    all:  ["action","test1","test2","test3","test4","test5","test6","test7","test8","test9","test10","test11","test12"],

    // ★手動：偶数（例：テスト2,4,6,8,10,12だけ表示）
    even: ["action","test2","test4","test6","test8","test10","test12"],

    // ★手動：奇数（例：テスト1,3,5,7,9,11だけ表示）
    odd:  ["action","test1","test3","test5","test7","test9","test11"]
  };

  // =============================
  // 4) ページング設定
  // =============================
  const PAGINATION_THRESHOLD = 100; // 100件以上でページネーション表示
  const PAGE_SIZE = 50;

  // =============================
  // 5) 状態
  // =============================
  let currentPage = 1;
  let currentPreset = $("#columnPreset").val() || "all";
  let currentRowIndex = null; // モーダルで開いている行（recordsのindex）

  // =============================
  // 6) テーブル構造（colgroup / thead）生成
  // =============================
  function buildTableSkeleton() {
    const $cg = $("#colgroup").empty();
    const $tr = $("#theadRow").empty();

    COLS.forEach(col => {
      $cg.append(`<col data-col="${col.key}" style="width:${col.width}px">`);

      if (col.isAction) {
        $tr.append(`<th class="col-action" data-col="${col.key}">${col.label}</th>`);
      } else {
        $tr.append(`<th data-col="${col.key}">${col.label}</th>`);
      }
    });
  }

  // =============================
  // 7) 列プリセット適用（thead/tbody/colgroup）
  // =============================
  function applyColumnPreset(presetKey) {
    const list = COLUMN_PRESETS[presetKey] || COLUMN_PRESETS.all;
    const showCols = new Set(list);

    $("#mainTable [data-col]").each(function () {
      const key = $(this).data("col");
      $(this).toggle(showCols.has(key));
    });

    $("#mainTable colgroup col[data-col]").each(function () {
      const key = $(this).data("col");
      $(this).toggle(showCols.has(key));
    });
  }

  // 現在表示されている列キー（action以外）を返す
  function getVisibleDataKeys() {
    const list = COLUMN_PRESETS[currentPreset] || COLUMN_PRESETS.all;
    return list.filter(k => k !== "action");
  }

  // key -> label
  const colLabelMap = Object.fromEntries(COLS.map(c => [c.key, c.label]));

  // =============================
  // 8) ページング UI
  // =============================
  function clampPage(page, totalPages) {
    if (totalPages <= 0) return 1;
    return Math.min(Math.max(1, page), totalPages);
  }

  function buildPageList(current, total, maxNumbers) {
    if (total <= maxNumbers) {
      return Array.from({length: total}, (_, i) => i + 1);
    }
    const out = [];
    const mid = Math.floor((maxNumbers - 3) / 2);

    out.push(1);

    let left = Math.max(2, current - mid);
    let right = Math.min(total - 1, current + mid);

    if (left > 2) out.push("...");
    for (let i = left; i <= right; i++) out.push(i);
    if (right < total - 1) out.push("...");

    out.push(total);
    return out;
  }

  function renderPager(totalPages) {
    const maxNumbers = 7;
    const pages = buildPageList(currentPage, totalPages, maxNumbers);
    const li = [];

    li.push(`
      <li class="page-item ${currentPage === 1 ? "disabled" : ""}">
        <a class="page-link" href="#" data-page="${currentPage - 1}">前へ</a>
      </li>
    `);

    pages.forEach(p => {
      if (p === "...") {
        li.push(`<li class="page-item disabled"><span class="page-link">…</span></li>`);
      } else {
        li.push(`
          <li class="page-item ${p === currentPage ? "active" : ""}">
            <a class="page-link" href="#" data-page="${p}">${p}</a>
          </li>
        `);
      }
    });

    li.push(`
      <li class="page-item ${currentPage === totalPages ? "disabled" : ""}">
        <a class="page-link" href="#" data-page="${currentPage + 1}">次へ</a>
      </li>
    `);

    $("#pager").html(li.join(""));
  }

  // =============================
  // 9) テーブル描画（records: 配列オブジェクト）
  // =============================
  function renderTable() {
    const total = records.length;
    const usePager = total >= PAGINATION_THRESHOLD;

    const totalPages = usePager ? Math.ceil(total / PAGE_SIZE) : 1;
    currentPage = clampPage(currentPage, totalPages);

    const start = usePager ? (currentPage - 1) * PAGE_SIZE : 0;
    const end = usePager ? start + PAGE_SIZE : total;
    const pageItems = records.slice(start, end);

    const from = total ? (start + 1) : 0;
    const to = total ? Math.min(end, total) : 0;
    $("#resultInfo").text(`件数: ${total}件（表示: ${from}〜${to}）`);

    const rowsHtml = pageItems.map((obj, idxInPage) => {
      const globalIndex = start + idxInPage;

      const tds = [];

      // 操作列（詳細/申請）
      tds.push(`
        <td class="col-action" data-col="action">
          <div class="action-btns">
            <button
              type="button"
              class="btn btn-outline-primary btn-sm js-open-modal"
              data-bs-toggle="modal"
              data-bs-target="#detailModal"
              data-index="${globalIndex}"
            >詳細</button>

            <button
              type="button"
              class="btn btn-outline-success btn-sm js-apply"
              data-index="${globalIndex}"
            >申請</button>
          </div>
        </td>
      `);

      // テスト列
      for (let c = 1; c <= TEST_COL_COUNT; c++) {
        const key = `test${c}`;
        const v = obj[key] ?? "-";
        tds.push(`<td data-col="${key}" title="${v}">${v}</td>`);
      }

      return `<tr>${tds.join("")}</tr>`;
    }).join("");

    $("#mainTbody").html(rowsHtml);

    if (usePager) {
      $("#pagerWrap").removeClass("d-none");
      renderPager(totalPages);
    } else {
      $("#pagerWrap").addClass("d-none");
      $("#pager").empty();
    }

    // tbody再描画後に列プリセットを必ず適用
    applyColumnPreset(currentPreset);
  }

  // =============================
  // 10) モーダル：閲覧/編集切替（上部）
  // =============================
  function switchToViewMode() {
    $(".edit-mode").addClass("d-none");
    $(".view-mode").removeClass("d-none");
    $("#viewModeBtn").addClass("active");
    $("#editModeBtn").removeClass("active");
  }
  function switchToEditMode() {
    $(".view-mode").addClass("d-none");
    $(".edit-mode").removeClass("d-none");
    $("#editModeBtn").addClass("active");
    $("#viewModeBtn").removeClass("active");
  }
  $("#viewModeBtn").on("click", switchToViewMode);
  $("#editModeBtn").on("click", switchToEditMode);
  $("#detailModal").on("hidden.bs.modal", switchToViewMode);

  // =============================
  // 11) 詳細モーダル：現在の列プリセットに応じて表示する項目を生成
  //     - 閲覧用(p) + 編集用(input) を両方生成して切替
  //     - テスト1は編集不可（readonly + 色変更）
  // =============================
  function buildDetailModalForRow(rowObj) {
    const visibleKeys = getVisibleDataKeys(); // action 제외
    const $container = $("#detailContainer").empty();

    visibleKeys.forEach(key => {
      const label = colLabelMap[key] || key;
      const value = rowObj[key] ?? "-";

      const isReadonly = (key === "test1"); // テスト1は編集不可
      const readonlyAttrs = isReadonly ? 'readonly tabindex="-1"' : "";
      const readonlyClass = isReadonly ? "bg-light text-muted" : "";

      const block = `
        <div class="kv-row" data-key="${key}">
          <div class="kv-key">${label}</div>

          <div>
            <p class="form-control-plaintext m-0 view-mode" id="view_${key}">${value}</p>
            <input
              type="text"
              class="form-control edit-mode d-none ${readonlyClass}"
              id="edit_${key}"
              value="${escapeAttr(value)}"
              ${readonlyAttrs}
            >
          </div>
        </div>
      `;
      $container.append(block);
    });
  }

  function escapeAttr(s) {
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // =============================
  // 12) イベント
  // =============================

  // 列プリセット変更（テーブルもモーダル表示項目もこれに追従）
  $("#columnPreset").on("change", function () {
    currentPreset = $(this).val();
    applyColumnPreset(currentPreset);

    // モーダルを開いたまま変更されたら、表示項目も作り直す（任意）
    if ($("#detailModal").hasClass("show") && currentRowIndex != null) {
      buildDetailModalForRow(records[currentRowIndex]);
      switchToViewMode();
    }
  });

  // ページクリック
  $(document).on("click", "#pager a.page-link", function (e) {
    e.preventDefault();
    const page = Number($(this).data("page"));
    if (!Number.isFinite(page)) return;

    const totalPages = Math.ceil(records.length / PAGE_SIZE);
    currentPage = clampPage(page, totalPages);
    renderTable();
    $(".table-wrap").scrollTop(0);
  });

  // 詳細
  $(document).on("click", ".js-open-modal", function () {
    const idx = Number($(this).data("index"));
    if (!Number.isFinite(idx) || !records[idx]) return;

    currentRowIndex = idx;
    buildDetailModalForRow(records[idx]);
    switchToViewMode();
  });

  // 申請（デモ）
  $(document).on("click", ".js-apply", function () {
    const idx = Number($(this).data("index"));
    if (!Number.isFinite(idx) || !records[idx]) return;
    alert(`申請しました（デモ）: 行=${idx+1}, テスト1=${records[idx].test1}`);
  });

  // 保存：表示中の列だけフォームから読み取ってrecordsへ反映
  $("#saveBtn").on("click", function () {
    if (currentRowIndex == null || !records[currentRowIndex]) return;

    const row = records[currentRowIndex];
    const visibleKeys = getVisibleDataKeys();

    visibleKeys.forEach(key => {
      if (key === "test1") return; // 編集不可
      const v = $(`#edit_${key}`).val();
      row[key] = v;
      $(`#view_${key}`).text(v || "-");
    });

    // 一覧にも反映
    renderTable();
    switchToViewMode();
  });

  // ダミー追加（配列オブジェクトに1行追加）
  $("#addDummyRowBtn").on("click", function () {
    const nextRowNo = records.length + 1;
    const obj = {};
    for (let c = 1; c <= TEST_COL_COUNT; c++) {
      obj[`test${c}`] = `値${c}-${nextRowNo}`;
    }
    records.push(obj);
    renderTable();
  });

  // =============================
  // 13) 初期化
  // =============================
  buildTableSkeleton();
  renderTable();
  applyColumnPreset(currentPreset);
});
</script>

</body>
</html>
