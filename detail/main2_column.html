<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bootstrap + jQuery（列プリセット手動・詳細は表示中カラムのみ・編集UI付き）</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    /* readonly は見た目で分かるように */
    .form-control[readonly] { cursor: not-allowed; }

    /* 横・縦スクロール */
    .table-wrap{
      max-height: 60vh;
      overflow-y: auto;
      overflow-x: auto;
    }

    /* 列幅制御のため固定レイアウト */
    table.fixed-table{
      table-layout: fixed;
      width: 100%;
    }

    /* 操作カラム固定幅（カラム数が増えても変わらない） */
    th.col-action, td.col-action{
      width: 180px;
      min-width: 180px;
      max-width: 180px;
      white-space: nowrap;
      text-align: center;
      vertical-align: middle;
    }

    .action-btns{
      display: inline-flex;
      gap: .25rem;
      justify-content: center;
      width: 100%;
    }

    td, th { overflow: hidden; text-overflow: ellipsis; }

    /* 編集された入力の背景色 */
    .edited-input{
      background-color: #fff3cd !important; /* 薄い黄色 */
    }

    /* 詳細モーダル下部テーブル：編集されたセル */
    td.edited-cell{
      background-color: #fff3cd !important;
    }

    /* 詳細モーダル下部テーブル：入力の幅 */
    .cell-input{
      width: 100%;
      min-width: 120px;
    }
  </style>
</head>
<body class="bg-light">

<div class="container py-4">

  <!-- Header -->
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <h1 class="h4 m-0">トップ画面</h1>

    <div class="d-flex flex-wrap gap-2 align-items-center">
      <!-- 列プリセット（手動設定） -->
      <select class="form-select form-select-sm w-auto" id="columnPreset">
        <option value="all" selected>全件</option>
        <option value="even">偶数</option>
        <option value="odd">奇数</option>
      </select>

      <button class="btn btn-primary btn-sm" type="button" id="addDummyRowBtn">ダミー追加</button>
    </div>
  </div>

  <!-- Table -->
  <div class="card shadow-sm">
    <div class="card-body">

      <div class="table-wrap">
        <table class="table table-bordered table-hover align-middle mb-0 fixed-table" id="mainTable">

          <!-- colgroup / thead はJSで生成（テスト1..N） -->
          <colgroup id="colgroup"></colgroup>

          <thead class="table-light">
            <tr id="theadRow"></tr>
          </thead>

          <tbody id="mainTbody"></tbody>
        </table>
      </div>

      <!-- ページネーション（100件以上のときだけ表示） -->
      <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mt-3">
        <div class="text-muted small" id="resultInfo">-</div>

        <nav aria-label="ページネーション" id="pagerWrap" class="d-none">
          <ul class="pagination pagination-sm mb-0" id="pager"></ul>
        </nav>
      </div>

    </div>
  </div>
</div>

<!-- ========== 詳細モーダル ========== -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header d-flex justify-content-between align-items-center">
        <h5 class="modal-title">詳細</h5>

        <!-- 上部で閲覧/編集切替 -->
        <div class="btn-group btn-group-sm" role="group" aria-label="閲覧編集切り替え">
          <button type="button" class="btn btn-outline-secondary active" id="viewModeBtn">閲覧</button>
          <button type="button" class="btn btn-outline-secondary" id="editModeBtn">編集</button>
        </div>
      </div>

      <div class="modal-body">
        <!-- 表示中のカラムだけを動的生成 -->
        <form id="detailForm">
          <div id="detailFields"></div>
        </form>

        <hr class="my-4">

        <div class="d-flex align-items-center justify-content-between">
          <h6 class="m-0">下部テーブル</h6>
          <span class="text-muted small">意味のないデータ（例）</span>
        </div>

        <div class="table-responsive mt-2">
          <table class="table table-bordered table-sm align-middle mb-0" id="detailSubTable">
            <thead class="table-light">
              <tr>
                <th style="min-width:140px;">ColA</th>
                <th style="min-width:140px;">ColB</th>
                <th style="min-width:140px;">ColC</th>
              </tr>
            </thead>
            <tbody id="detailSubTbody">
              <!-- JSで描画 -->
            </tbody>
          </table>
        </div>

      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">閉じる</button>
        <button type="submit" class="btn btn-success edit-mode d-none" form="detailForm">保存</button>
      </div>

    </div>
  </div>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
$(function () {
  // =========================================================
  // 設定
  // =========================================================
  const TEST_COL_COUNT = 12;          // テスト1〜テスト12
  const PAGINATION_THRESHOLD = 100;   // 100件以上でページネーション
  const PAGE_SIZE = 50;

  // =========================================================
  // 列プリセット（★手動で設定★）
  // - action は常に表示
  // - even / odd は「手動で」列キーを並べる（自動生成しない）
  // =========================================================
  const COLUMN_PRESETS = {
    all:  ["action", ...Array.from({length: TEST_COL_COUNT}, (_, i) => `test${i+1}`)],
    even: ["action", "test2", "test4", "test6", "test8", "test10", "test12"],  // ←手動
    odd:  ["action", "test1", "test3", "test5", "test7", "test9", "test11"]    // ←手動
  };

  // =========================================================
  // 例：配列内にオブジェクトがある形式（1オブジェクト=1行）
  // - test1 も「値1-1」形式にする
  // - test2 は「テスト2+」「テスト2-」のみ
  // - test3/test4 は boolean（チェックボックス用）
  // - subRows は詳細下部テーブル用（意味のないデータ）
  // =========================================================
  const data = buildExampleData(230);

  // state
  let currentPreset = $("#columnPreset").val() || "all";
  let currentPage = 1;
  let currentRowId = null; // 詳細表示中の行ID（ここではtest1をキー扱い）

  // =========================================================
  // テーブル列（colgroup / thead）を生成
  // =========================================================
  function buildColumns() {
    const $cg = $("#colgroup").empty();
    const $tr = $("#theadRow").empty();

    // action
    $cg.append(`<col data-col="action" style="width:180px">`);
    $tr.append(`<th class="col-action" data-col="action">操作</th>`);

    // テスト1..N
    for (let i = 1; i <= TEST_COL_COUNT; i++) {
      const key = `test${i}`;
      const w = (i === 1) ? 120 : 160;
      $cg.append(`<col data-col="${key}" style="width:${w}px">`);
      $tr.append(`<th data-col="${key}">テスト${i}</th>`);
    }
  }

  // =========================================================
  // 列プリセット適用（thead/tbody/colgroup の data-col を一括 show/hide）
  // =========================================================
  function applyColumnPreset(presetKey) {
    const cols = COLUMN_PRESETS[presetKey] || COLUMN_PRESETS.all;
    const showSet = new Set(cols);

    $("#mainTable [data-col]").each(function () {
      const key = $(this).data("col");
      $(this).toggle(showSet.has(key));
    });

    $("#mainTable colgroup col[data-col]").each(function () {
      const key = $(this).data("col");
      $(this).toggle(showSet.has(key));
    });
  }

  // =========================================================
  // ページネーション
  // =========================================================
  function clampPage(page, totalPages) {
    if (totalPages <= 0) return 1;
    return Math.min(Math.max(1, page), totalPages);
  }

  function buildPageList(current, total, maxNumbers) {
    if (total <= maxNumbers) return Array.from({length: total}, (_, i) => i + 1);

    const out = [];
    const mid = Math.floor((maxNumbers - 3) / 2);

    out.push(1);

    let left = Math.max(2, current - mid);
    let right = Math.min(total - 1, current + mid);

    if (left > 2) out.push("...");
    for (let i = left; i <= right; i++) out.push(i);
    if (right < total - 1) out.push("...");

    out.push(total);
    return out;
  }

  function renderPager(totalPages) {
    const pages = buildPageList(currentPage, totalPages, 7);
    const li = [];

    li.push(`
      <li class="page-item ${currentPage === 1 ? "disabled" : ""}">
        <a class="page-link" href="#" data-page="${currentPage - 1}">前へ</a>
      </li>
    `);

    pages.forEach(p => {
      if (p === "...") {
        li.push(`<li class="page-item disabled"><span class="page-link">…</span></li>`);
      } else {
        li.push(`
          <li class="page-item ${p === currentPage ? "active" : ""}">
            <a class="page-link" href="#" data-page="${p}">${p}</a>
          </li>
        `);
      }
    });

    li.push(`
      <li class="page-item ${currentPage === totalPages ? "disabled" : ""}">
        <a class="page-link" href="#" data-page="${currentPage + 1}">次へ</a>
      </li>
    `);

    $("#pager").html(li.join(""));
  }

  // =========================================================
  // 一覧テーブル描画（data配列 -> tbody）
  // =========================================================
  function renderMainTable() {
    const total = data.length;
    const usePager = total >= PAGINATION_THRESHOLD;
    const totalPages = usePager ? Math.ceil(total / PAGE_SIZE) : 1;
    currentPage = clampPage(currentPage, totalPages);

    const start = usePager ? (currentPage - 1) * PAGE_SIZE : 0;
    const end = usePager ? start + PAGE_SIZE : total;
    const rows = data.slice(start, end);

    const from = total ? (start + 1) : 0;
    const to = total ? Math.min(end, total) : 0;
    $("#resultInfo").text(`件数: ${total}件（表示: ${from}〜${to}）`);

    const html = rows.map(r => {
      const tds = [];

      // 操作列（固定幅）
      tds.push(`
        <td class="col-action" data-col="action">
          <div class="action-btns">
            <button
              type="button"
              class="btn btn-outline-primary btn-sm js-open-modal"
              data-bs-toggle="modal"
              data-bs-target="#detailModal"
              data-id="${escapeHtml(r.test1)}"
            >詳細</button>

            <button
              type="button"
              class="btn btn-outline-success btn-sm js-apply"
              data-id="${escapeHtml(r.test1)}"
            >申請</button>
          </div>
        </td>
      `);

      for (let i = 1; i <= TEST_COL_COUNT; i++) {
        const key = `test${i}`;
        tds.push(renderMainCell(key, r[key]));
      }

      return `<tr>${tds.join("")}</tr>`;
    }).join("");

    $("#mainTbody").html(html);

    if (usePager) {
      $("#pagerWrap").removeClass("d-none");
      renderPager(totalPages);
    } else {
      $("#pagerWrap").addClass("d-none");
      $("#pager").empty();
    }

    // 再描画後に列プリセットを必ず適用
    applyColumnPreset(currentPreset);
  }

  function renderMainCell(key, value) {
    // test3/test4 が boolean の想定（一覧は見やすく表示）
    if (key === "test3" || key === "test4") {
      const v = !!value;
      const text = v ? "✓" : "-";
      return `<td data-col="${key}" class="text-center">${text}</td>`;
    }
    return `<td data-col="${key}" title="${escapeHtml(value)}">${escapeHtml(value)}</td>`;
  }

  // =========================================================
  // 詳細：表示中の列だけフォームを生成（現在のプリセットに追従）
  // - test2: select（テスト2+ / テスト2-）
  // - test3/test4: checkbox
  // - test1: 編集不可（readonly）
  // =========================================================
  function getVisibleTestColsForDetail() {
    const cols = COLUMN_PRESETS[currentPreset] || COLUMN_PRESETS.all;
    // action は詳細には出さない
    return cols.filter(c => c !== "action");
  }

  function buildDetailFields(rowObj) {
    const cols = getVisibleTestColsForDetail();
    const $wrap = $("#detailFields").empty();

    cols.forEach(colKey => {
      const label = toLabel(colKey);
      const value = rowObj[colKey];

      // 共通枠
      const $row = $(`
        <div class="row mb-3" data-detail-col="${colKey}">
          <label class="col-sm-3 col-form-label">${label}</label>
          <div class="col-sm-9">
            <div class="view-mode" data-view></div>
            <div class="edit-mode d-none" data-edit></div>
          </div>
        </div>
      `);

      // view
      const $view = $row.find('[data-view]');
      if (colKey === "test3" || colKey === "test4") {
        $view.html(`<p class="form-control-plaintext m-0">${value ? "✓" : "-"}</p>`);
      } else {
        $view.html(`<p class="form-control-plaintext m-0">${escapeHtml(value)}</p>`);
      }

      // edit
      const $edit = $row.find('[data-edit]');

      if (colKey === "test1") {
        $edit.html(`
          <input type="text"
            class="form-control bg-light text-muted js-edit-input"
            name="${colKey}"
            value="${escapeHtml(value)}"
            readonly
            tabindex="-1">
        `);
      } else if (colKey === "test2") {
        // select
        const v = (value === "テスト2-" ? "テスト2-" : "テスト2+");
        $edit.html(`
          <select class="form-select js-edit-input" name="${colKey}">
            <option value="テスト2+" ${v === "テスト2+" ? "selected" : ""}>テスト2+</option>
            <option value="テスト2-" ${v === "テスト2-" ? "selected" : ""}>テスト2-</option>
          </select>
        `);
      } else if (colKey === "test3" || colKey === "test4") {
        // checkbox
        const checked = value ? "checked" : "";
        $edit.html(`
          <div class="form-check">
            <input class="form-check-input js-edit-input" type="checkbox" name="${colKey}" ${checked}>
            <label class="form-check-label">選択</label>
          </div>
        `);
      } else {
        // text
        $edit.html(`
          <input type="text" class="form-control js-edit-input" name="${colKey}" value="${escapeHtml(value)}">
        `);
      }

      $wrap.append($row);
    });
  }

  // =========================================================
  // 詳細：下部テーブル描画（意味のないデータ）
  // - 閲覧：テキスト
  // - 編集：input
  // - 入力したセルの背景色変更（td.edited-cell）
  // =========================================================
  function renderDetailSubTable(rowObj) {
    const rows = rowObj.subRows || [];
    const html = rows.map((r, idx) => `
      <tr data-sub-row="${idx}">
        ${renderSubCell("a", r.a)}
        ${renderSubCell("b", r.b)}
        ${renderSubCell("c", r.c)}
      </tr>
    `).join("");

    $("#detailSubTbody").html(html);

    // 現在モードに合わせて表示（後でtoggleで切替するため両方用意）
    // -> ここでは cell内に view/edit 両方を描画しておく
    $("#detailSubTbody tr").each(function () {
      const $tr = $(this);
      const rowIndex = Number($tr.data("sub-row"));

      ["a","b","c"].forEach(k => {
        const $td = $tr.find(`td[data-sub-col="${k}"]`);
        const v = rowObj.subRows[rowIndex][k] ?? "";

        $td.html(`
          <div class="view-mode" data-sub-view><span>${escapeHtml(v)}</span></div>
          <div class="edit-mode d-none" data-sub-edit>
            <input class="form-control form-control-sm cell-input js-sub-input"
              data-sub-row="${rowIndex}" data-sub-col="${k}"
              value="${escapeHtml(v)}">
          </div>
        `);
      });
    });
  }

  function renderSubCell(colKey, value) {
    return `<td data-sub-col="${colKey}">${escapeHtml(value)}</td>`;
  }

  // =========================================================
  // モード切替（モーダル上部）
  // =========================================================
  function switchToViewMode() {
    $("#detailModal .edit-mode").addClass("d-none");
    $("#detailModal .view-mode").removeClass("d-none");
    $("#viewModeBtn").addClass("active");
    $("#editModeBtn").removeClass("active");
  }

  function switchToEditMode() {
    $("#detailModal .view-mode").addClass("d-none");
    $("#detailModal .edit-mode").removeClass("d-none");
    $("#editModeBtn").addClass("active");
    $("#viewModeBtn").removeClass("active");
  }

  $("#viewModeBtn").on("click", switchToViewMode);
  $("#editModeBtn").on("click", switchToEditMode);
  $("#detailModal").on("hidden.bs.modal", function () {
    currentRowId = null;
    switchToViewMode();
    // 次回のために編集ハイライトを消す
    $("#detailFields .js-edit-input").removeClass("edited-input");
    $("#detailSubTbody td").removeClass("edited-cell");
  });

  // =========================================================
  // イベント：列プリセット変更
  // - 一覧は列の表示/非表示
  // - 詳細は「次に開いた時」表示する項目が変わる（開いてる最中に変えた場合も反映）
  // =========================================================
  $("#columnPreset").on("change", function () {
    currentPreset = $(this).val();
    applyColumnPreset(currentPreset);

    // もし詳細が開いていて対象行があるなら、詳細フォームも「表示中カラム」に合わせて作り直す
    if (currentRowId) {
      const rowObj = findById(currentRowId);
      if (rowObj) {
        buildDetailFields(rowObj);
        renderDetailSubTable(rowObj);
        // いまのモードを維持（activeボタンで判定）
        if ($("#editModeBtn").hasClass("active")) switchToEditMode();
        else switchToViewMode();
      }
    }
  });

  // =========================================================
  // イベント：ページクリック
  // =========================================================
  $(document).on("click", "#pager a.page-link", function (e) {
    e.preventDefault();
    const page = Number($(this).data("page"));
    if (!Number.isFinite(page)) return;

    const totalPages = Math.ceil(data.length / PAGE_SIZE);
    currentPage = clampPage(page, totalPages);
    renderMainTable();
    $(".table-wrap").scrollTop(0);
  });

  // =========================================================
  // 詳細ボタン：モーダルへ反映（現在のプリセットで表示中の列だけ）
  // =========================================================
  $(document).on("click", ".js-open-modal", function () {
    const id = $(this).data("id");
    const rowObj = findById(id);
    if (!rowObj) return;

    currentRowId = id;

    // フィールドを「表示中カラム」に合わせて生成
    buildDetailFields(rowObj);

    // 下部テーブル描画（意味のないデータ）
    renderDetailSubTable(rowObj);

    // 初期は閲覧
    switchToViewMode();
  });

  // 申請（デモ）
  $(document).on("click", ".js-apply", function () {
    const id = $(this).data("id");
    alert(`申請しました（デモ）: テスト1=${id}`);
  });

  // =========================================================
  // 編集時：入力したら背景色変更（フォーム上側）
  // =========================================================
  $(document).on("input change", "#detailFields .js-edit-input", function () {
    $(this).addClass("edited-input");
  });

  // 編集時：下部テーブルのセル入力で背景色変更（td単位）
  $(document).on("input", ".js-sub-input", function () {
    const $input = $(this);
    const $td = $input.closest("td");
    $td.addClass("edited-cell");
    $input.addClass("edited-input");
  });

  // =========================================================
  // 保存：上側フォーム＋下部テーブルを data に反映して一覧も更新
  // =========================================================
  $("#detailForm").on("submit", function (e) {
    e.preventDefault();
    if (!currentRowId) return;

    const rowObj = findById(currentRowId);
    if (!rowObj) return;

    // 上側フォーム：表示中カラムだけ更新
    const cols = getVisibleTestColsForDetail();
    cols.forEach(colKey => {
      if (colKey === "test3" || colKey === "test4") {
        rowObj[colKey] = !!$(`#detailFields [name="${colKey}"]`).prop("checked");
      } else {
        const v = $(`#detailFields [name="${colKey}"]`).val();
        if (colKey === "test2") {
          // テスト2は "テスト2+" or "テスト2-"
          rowObj[colKey] = (v === "テスト2-") ? "テスト2-" : "テスト2+";
        } else if (typeof v !== "undefined") {
          rowObj[colKey] = v;
        }
      }
    });

    // 下部テーブル：入力を反映
    $("#detailSubTbody .js-sub-input").each(function () {
      const rowIndex = Number($(this).data("sub-row"));
      const col = String($(this).data("sub-col"));
      const v = $(this).val();

      if (!rowObj.subRows) rowObj.subRows = [];
      if (!rowObj.subRows[rowIndex]) rowObj.subRows[rowIndex] = {a:"",b:"",c:""};
      rowObj.subRows[rowIndex][col] = v;
    });

    // 詳細表示を作り直して閲覧へ
    buildDetailFields(rowObj);
    renderDetailSubTable(rowObj);
    switchToViewMode();

    // 一覧も再描画（表示更新）
    renderMainTable();
  });

  // =========================================================
  // ダミー追加（配列にオブジェクトをpushして表示する例）
  // =========================================================
  $("#addDummyRowBtn").on("click", function () {
    const nextIndex = data.length + 1;
    data.push(buildOneRow(nextIndex));
    renderMainTable();
  });

  // =========================================================
  // 初期化
  // =========================================================
  buildColumns();
  renderMainTable();
  applyColumnPreset(currentPreset);

  // =========================================================
  // ヘルパー
  // =========================================================
  function findById(test1) {
    return data.find(r => String(r.test1) === String(test1)) || null;
  }

  function toLabel(colKey) {
    if (!/^test\d+$/.test(colKey)) return colKey;
    const n = Number(colKey.replace("test",""));
    return `テスト${n}`;
  }

  function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function buildExampleData(count) {
    const arr = [];
    for (let i = 1; i <= count; i++) arr.push(buildOneRow(i));
    return arr;
  }

  function buildOneRow(i) {
    // 1オブジェクト=1行
    const obj = {};
    obj.test1 = `値1-${i}`; // ←要望：テスト1も「値1-1」形式
    obj.test2 = (i % 2 === 0) ? "テスト2-" : "テスト2+";
    obj.test3 = (i % 3 === 0);
    obj.test4 = (i % 4 === 0);

    // test5..test12
    for (let c = 5; c <= TEST_COL_COUNT; c++) {
      obj[`test${c}`] = `値${c}-${i}`;
    }

    // 下部テーブル（意味を持たないデータ）
    obj.subRows = [
      { a: `A-${i}-1`, b: `B-${i}-1`, c: `C-${i}-1` },
      { a: `A-${i}-2`, b: `B-${i}-2`, c: `C-${i}-2` },
      { a: `A-${i}-3`, b: `B-${i}-3`, c: `C-${i}-3` },
    ];
    return obj;
  }
});
</script>

</body>
</html>